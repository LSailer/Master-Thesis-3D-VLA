\documentclass[tikz,border=8pt]{standalone}
\usepackage{tikz}
\usetikzlibrary{shapes.geometric,arrows.meta,fit,positioning,backgrounds,calc}

\tikzstyle{block} = [rectangle, rounded corners=3pt, draw=black!60,
    fill=blue!8, minimum height=0.7cm, text centered, font=\small,
    inner sep=4pt]
\tikzstyle{optblock} = [block, dashed, fill=gray!8]
\tikzstyle{shapelabel} = [font=\scriptsize\ttfamily, text=black!55,
    inner sep=1pt, text centered]

\begin{document}
\begin{tikzpicture}[node distance=0.5cm and 0.7cm,
                     every path/.style={>=Stealth}]


  %% ── Panel A: Overview ──────────────────────────────────────────────────
  \node[block,  minimum width=1.8cm] (input)  at (0,0)  {Input};
  \node[shapelabel, below=1pt of input] (input_s) {\scriptsize[1,3,3,350,518]};

  \node[block,  minimum width=2.2cm, right=1.2cm of input]  (agg)   {Aggregator};
  \node[shapelabel, below=1pt of agg]   (agg_s)  {\scriptsize[1,3,930,2048]};

  \node[block,  minimum width=2.0cm, right=1.4cm of agg, yshift= 1.6cm]  (camH)  {CameraHead};
  \node[block,  minimum width=2.0cm, right=1.4cm of agg, yshift= 0.4cm]  (dptD)  {DPTHead (depth)};
  \node[block,  minimum width=2.0cm, right=1.4cm of agg, yshift=-0.8cm]  (dptP)  {DPTHead (point)};
  \node[optblock, minimum width=2.0cm, right=1.4cm of agg, yshift=-2.0cm] (trkH)  {TrackHead*};

  \node[shapelabel, right=0.6cm of camH] (camH_s) {\scriptsize[1,3,9]};
  \node[shapelabel, right=0.6cm of dptD] (dptD_s) {\scriptsize[B,S,350,518,1]};
  \node[shapelabel, right=0.6cm of dptP] (dptP_s) {\scriptsize[B,S,350,518,3]};
  \node[shapelabel, right=0.6cm of trkH] (trkH_s) {\scriptsize[B,S,N,2]};

  \draw[->, thick] (input) -- (agg);
  \draw[->, thick] (agg.east) -- ++(0.5,0) |- (camH.west);
  \draw[->, thick] (agg.east) -- ++(0.5,0) |- (dptD.west);
  \draw[->, thick] (agg.east) -- ++(0.5,0) |- (dptP.west);
  \draw[->, thick, dashed] (agg.east) -- ++(0.5,0) |- (trkH.west);
  \draw[->, thick] (camH.east) -- (camH_s);
  \draw[->, thick] (dptD.east) -- (dptD_s);
  \draw[->, thick] (dptP.east) -- (dptP_s);
  \draw[->, thick, dashed] (trkH.east) -- (trkH_s);

  \node[anchor=north west, font=\bfseries\small] at (-0.9,0.8) {A\quad Overview};
  \node[shapelabel, below=2pt of trkH] {\scriptsize* optional: needs query\_points};


  %% ── Panel B: Aggregator ────────────────────────────────────────────────
  \node[block, minimum width=2.2cm] (pe)  at (0,-5.5) {PatchEmbed};
  \node[shapelabel, below=1pt of pe]  {\scriptsize[3,925,1024]};

  \node[block, fill=yellow!20, minimum width=0.7cm, above right=0.1cm and 0.3cm of pe] (camtok) {cam};
  \node[block, fill=gray!20,   minimum width=1.0cm, right=0.05cm of camtok]             (regtok) {reg×4};

  \node[block, minimum width=2.2cm, right=1.0cm of pe, yshift=-0.1cm] (cat) {cat → [3,930,1024]};

  \node[block, minimum width=3.0cm, below=1.2cm of cat, dashed] (loop)
      {\parbox{2.8cm}{\centering×24\\[2pt]Frame-Attn Block\\Global-Attn Block}};
  \node[shapelabel, below=1pt of loop] {\scriptsize frame: [3,930,1024]};
  \node[shapelabel, below=12pt of loop] {\scriptsize global: [1,2790,1024]};

  \node[block, minimum width=2.2cm, below=1.6cm of loop] (agg_out)
      {concat 1024+1024→2048};
  \node[shapelabel, below=1pt of agg_out] {\scriptsize[1,3,930,2048]};

  \draw[->, thick] (pe)     -- (cat);
  \draw[->, thick] (camtok) |- (cat);
  \draw[->, thick] (regtok) |- (cat);
  \draw[->, thick] (cat)    -- (loop);
  \draw[->, thick] (loop)   -- (agg_out);

  \node[anchor=north west, font=\bfseries\small] at (-0.9,-4.7) {B\quad Aggregator};


  %% ── Panel C: DPT Head ──────────────────────────────────────────────────
  \node[block, minimum width=1.6cm] (proj0) at (9.0,-4.9) {proj};
  \node[block, minimum width=1.6cm, right=0.6cm of proj0] (rsz0)  {resize×4};
  \node[shapelabel, below=1pt of proj0] {\scriptsize[3,256,25,37]};
  \node[shapelabel, below=1pt of rsz0]  {\scriptsize[3,256,100,148]};
  \node[shapelabel, left=0.2cm of proj0, font=\scriptsize\ttfamily] {L4};

  \node[block, minimum width=1.6cm, below=0.7cm of proj0] (proj1) {proj};
  \node[block, minimum width=1.6cm, right=0.6cm of proj1] (rsz1)  {resize×2};
  \node[shapelabel, below=1pt of proj1] {\scriptsize[3,512,25,37]};
  \node[shapelabel, below=1pt of rsz1]  {\scriptsize[3,512,50,74]};
  \node[shapelabel, left=0.2cm of proj1, font=\scriptsize\ttfamily] {L11};

  \node[block, minimum width=1.6cm, below=0.7cm of proj1] (proj2) {proj};
  \node[block, minimum width=1.6cm, right=0.6cm of proj2] (rsz2)  {identity};
  \node[shapelabel, below=1pt of proj2] {\scriptsize[3,1024,25,37]};
  \node[shapelabel, below=1pt of rsz2]  {\scriptsize[3,1024,25,37]};
  \node[shapelabel, left=0.2cm of proj2, font=\scriptsize\ttfamily] {L17};

  \node[block, minimum width=1.6cm, below=0.7cm of proj2] (proj3) {proj};
  \node[block, minimum width=1.6cm, right=0.6cm of proj3] (rsz3)  {conv↓2};
  \node[shapelabel, below=1pt of proj3] {\scriptsize[3,1024,25,37]};
  \node[shapelabel, below=1pt of rsz3]  {\scriptsize[3,1024,13,19]};
  \node[shapelabel, left=0.2cm of proj3, font=\scriptsize\ttfamily] {L23};

  %% FPN column
  \node[block, fill=green!10, minimum width=1.6cm, right=0.6cm of rsz3] (rn4) {refinenet4};
  \node[block, fill=green!10, minimum width=1.6cm, above=0.4cm of rn4]  (rn3) {refinenet3};
  \node[block, fill=green!10, minimum width=1.6cm, above=0.4cm of rn3]  (rn2) {refinenet2};
  \node[block, fill=green!10, minimum width=1.6cm, above=0.4cm of rn2]  (rn1) {refinenet1};
  \node[shapelabel, right=0.2cm of rn4] {\scriptsize[3,256,25,37]};
  \node[shapelabel, right=0.2cm of rn1] {\scriptsize[3,256,200,296]};

  \node[block, minimum width=1.6cm, above=0.4cm of rn1]  (conv2) {output\_conv2};
  \node[shapelabel, right=0.2cm of conv2] {\scriptsize[3,2,350,518]};

  \draw[->, thick] (proj0) -- (rsz0);
  \draw[->, thick] (proj1) -- (rsz1);
  \draw[->, thick] (proj2) -- (rsz2);
  \draw[->, thick] (proj3) -- (rsz3);
  \draw[->, thick] (rsz3.east) -- (rn4.west);
  \draw[->, thick] (rsz2.east) -- (rn3.west);
  \draw[->, thick] (rsz1.east) -- (rn2.west);
  \draw[->, thick] (rsz0.east) -- (rn1.west);
  \draw[->, thick] (rn4) -- (rn3);
  \draw[->, thick] (rn3) -- (rn2);
  \draw[->, thick] (rn2) -- (rn1);
  \draw[->, thick] (rn1) -- (conv2);

  \node[anchor=north west, font=\bfseries\small] at (8.1,-4.2) {C\quad DPT Head};


  %% ── Panel D: CameraHead ────────────────────────────────────────────────
  \node[block, minimum width=2.0cm] (ctn) at (16.0,-4.9) {token\_norm};
  \node[shapelabel, below=1pt of ctn] {\scriptsize[1,3,2048]};

  \node[block, minimum width=2.0cm, dashed, below=0.8cm of ctn] (loop2)
      {\parbox{1.8cm}{\centering×4 iters\\[3pt]embed\_pose\\AdaLN mod\\trunk[4 blocks]\\pose\_branch Δ}};
  \node[shapelabel, right=0.2cm of loop2, yshift=0.5cm] {\scriptsize[1,3,2048]};

  \node[block, minimum width=2.0cm, below=1.5cm of loop2] (cpose) {pose\_enc};
  \node[shapelabel, below=1pt of cpose] {\scriptsize[1,3,9]};

  \draw[->, thick] (ctn)   -- (loop2);
  \draw[->, thick] (loop2) -- (cpose);

  \node[anchor=north west, font=\bfseries\small] at (15.1,-4.2) {D\quad CameraHead};


  %% Divider lines between panels
  \draw[gray!40, thick, dashed] (-1,-4.2) -- (20,-4.2);

\end{tikzpicture}
\end{document}
